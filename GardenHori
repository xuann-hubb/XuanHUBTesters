local Players = game:GetService("Players")
local player = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

-- ================= LOAD WINDUI =================
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- ================= SET FONT (IMPORTANT) =================
-- WindUI text font
WindUI:SetFont("rbxasset://fonts/families/GothamSSm.json")

-- ================= CREATE WINDUI WINDOW =================
local Window = WindUI:CreateWindow({
    Folder = "XuanHub",
    Title = "XUAN HUB",
    Author = "by discord.gg/kaydensdens",
    Icon = "rbxassetid://103326199885496",
    Theme = "Dark",
    Size = UDim2.fromOffset(640, 480),
    Draggable = true,
    HasOutline = true,
    HideSearchBar = false,
    OutlineThickness = 3,
    Resizable = true,
    Transparent = true,
    User = {
        Enabled = true,
    },


})

Window:EditOpenButton({
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

-- Add version tag with FPS and Ping counter
local version = game.PlaceVersion -- Server version
local fps = 0
local ping = 0
local Stats = game:GetService("Stats")

local VersionTag = Window:Tag({
    Title = string.format("v%d | Ping: 0 | FPS: 0", version),
    Icon = "solar:server-bold",
    Color = Color3.fromRGB(255, 105, 180), -- Pink color
    Border = true,
})

local frames = 0
local last = os.clock()

RunService.RenderStepped:Connect(function()
    frames = frames + 1
    local now = os.clock()
    if now - last >= 1 then
        fps = frames
        frames = 0
        last = now

        -- Get ping
        pcall(function()
            local item = Stats.Network.ServerStatsItem:FindFirstChild("Data Ping")
            if item then
                ping = math.floor(item:GetValue())
            end
        end)

        -- Update tag
        VersionTag:SetTitle(string.format("v%d | Ping: %d | FPS: %d", version, ping, fps))
    end
end)

local MiscTab = Window:Tab({
    Title = "Settings",
    Icon = "settings",
    Locked = false,
})

-- Anti-AFK (Always Enabled - Prevents 20 min AFK kick)
local vu = game:GetService("VirtualUser")
player.Idled:Connect(function()
    vu:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    vu:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

-- Auto Reconnect (Always Enabled)
pcall(function()
    game.CoreGui.RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(child)
        if child.Name == 'ErrorPrompt' and child:FindFirstChild('MessageArea') and child.MessageArea:FindFirstChild("ErrorFrame") then
            game:GetService("TeleportService"):Teleport(game.PlaceId, player)
        end
    end)
end)

local MiscSettings = MiscTab:Section({
    Title = "Game Settings",
    Opened = true,
})

-- Anti-AFK (Always On)
MiscSettings:Button({
    Title = "Anti-AFK (Always On)",
    Desc = "Prevents AFK kick - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Anti-AFK is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscSettings:Space()

-- Auto Reconnect (Always On)
MiscSettings:Button({
    Title = "Auto Reconnect (Always On)",
    Desc = "Auto rejoin on disconnect - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Auto Reconnect is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscTab:Space()

MiscTab:Section({
    Title = "Server Actions",
    Opened = true,
})

local ServerGroup = MiscTab:Group()

ServerGroup:Button({
    Title = "Server Hop",
    Icon = "solar:refresh-bold",
    Callback = function()
        Window:ServerHop()
    end


})

ServerGroup:Space()

ServerGroup:Button({
    Title = "Rejoin",
    Icon = "solar:restart-bold",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
    end
})

-- ================= MAIN TAB (Shop) =================
local MainTab = Window:Tab({
    Title = "Main Tab",
    Icon = "shopping-cart",
    Locked = false,
})

local ShopSection = MainTab:Section({ Title = "Shop Section", Opened = true })

-- State
local selectedGearItem = {}
local selectedSeedItem = {}
local selectedFruitItem = {}
local autoBuyGear = false
local autoBuySeed = false
local autoSellFruit = false
local shopRefreshInterval = 5 -- seconds between automated purchase attempts (minimum 5s to avoid spam)
local fruitSellInterval = 1 -- seconds between fruit sell attempts
local scriptRunning = true
-- auto-plant/auto-harvest state will come from snippet logic
local autoPlant = false
local autoHarvest = false
local plantInterval = 0.8 -- used by snippet if needed
local Seeds = {"Carrot","Tomato","Potato","Wheat","Pumpkin","Corn","Strawberry","Blueberry","Onion","Garlic","Cabbage","Banana","Apple","Plum","Cherry","Mushroom","Rose"}
local selectedSeeds = {}
local selectedPlants = {}

-- previous helper for finding seed tool removed; using direct PlantSeed remote instead
-- Helpers: fetch shop items heuristically
local function fetchShopItems(shopId)
    -- Return exact, hardcoded lists for GearShop and SeedShop to match server item names
    if shopId == "GearShop" then
        return { "Watering Can", "Basic Sprinkler", "Harvest Bell", "Turbo Sprinkler", "Favorite Tool", "Super Sprinkler" }
    elseif shopId == "SeedShop" then
        return {
            "Carrot Seed",
            "Corn Seed",
            "Onion Seed",
            "Strawberry Seed",
            "Mushroom Seed",
            "Beetroot Seed",
            "Tomato Seed",
            "Apple Seed",
            "Rose Seed",
            "Wheat Seed",
            "Banana Seed",
            "Plum Seed",
            "Potato Seed",
            "Cabbage Seed",
            "Cherry Seed",
        }
    end
    return {}
end

-- gather list of fruit harvest origins present in backpack/equipped tools
local function fetchFruitItems()
    local fruits = {}
    local seen = {}
    local bp = player and player:FindFirstChild("Backpack")
    if bp then
        for _, tool in ipairs(bp:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    local char = player and player.Character
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    table.sort(fruits)
    return fruits
end

-- attempt to equip a tool corresponding to given fruit name
local function equipFruitTool(fruitName)
    local bp = player and player:FindFirstChild("Backpack")
    local char = player and player.Character
    if not bp or not char then return false end
    local humanoid = char:FindFirstChild("Humanoid")
    if not humanoid then return false end

    for _, tool in ipairs(bp:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                humanoid:EquipTool(tool)
                return true
            end
        end
    end
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                return true
            end
        end
    end
    return false
end

-- Normalize WindUI multi-select output into a set: { ["Name"] = true }
local function normalizeMultiSelection(option)
    if type(option) ~= "table" then
        return {}
    end

    local normalized = {}
    for k, v in pairs(option) do
        if type(k) == "number" then
            if type(v) == "string" and v ~= "" then
                normalized[v] = true
            end
        elseif v then
            normalized[k] = true
        end
    end
    return normalized
end

local function selectedKeys(tbl)
    local keys = {}
    if type(tbl) ~= "table" then
        return keys
    end
    for k, v in pairs(tbl) do
        if v then
            table.insert(keys, k)
        end
    end
    return keys
end

local function hasSelection(tbl)
    if type(tbl) ~= "table" then return false end
    for _, v in pairs(tbl) do
        if v then return true end
    end
    return false
end

-- find a seed tool in backpack/character whose BaseName attribute matches seedBase
-- findSeedTool removed (auto-plant disabled)

-- Attempt to trigger a harvest prompt safely using multiple fallbacks
-- fireHarvestPrompt removed (auto-harvest disabled)

local gearList = {}
local seedList = {}

-- Populate lists (keep them local tables to avoid accidental global usage)
gearList = fetchShopItems("GearShop")
seedList = fetchShopItems("SeedShop")

local GearDropdown = ShopSection:Dropdown({
    Title = "Gear Item",
    Desc = "Select gear to auto-buy",
    Values = gearList,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedGearItem = normalizeMultiSelection(option)
    end,
})

ShopSection:Toggle({
    Title = "Auto Buy Gear",
    Desc = "Automatically purchase selected gear",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuyGear = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy gear enabled" or "Auto-buy gear disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuyGear and scriptRunning do
                    if hasSelection(selectedGearItem) then
                        for _, item in ipairs(selectedKeys(selectedGearItem)) do
                            pcall(function()
                                local args = { "GearShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})

local SeedDropdown = ShopSection:Dropdown({
    Title = "Seed Item",
    Desc = "Select seed to auto-buy",
    Values = seedList,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedSeedItem = normalizeMultiSelection(option)
    end,
})

ShopSection:Toggle({
    Title = "Auto Buy Seed",
    Desc = "Automatically purchase selected seed",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuySeed = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy seed enabled" or "Auto-buy seed disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuySeed and scriptRunning do
                    if hasSelection(selectedSeedItem) then
                        for _, item in ipairs(selectedKeys(selectedSeedItem)) do
                            pcall(function()
                                local args = { "SeedShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})

-- Fruit dropdown moved to Automation tab (so selection sits with Auto Sell toggle)

-- Refresh buttons removed per user request
-- Slider for auto-buy delay
ShopSection:Slider({
    Title = "Auto Buy Delay (s)",
    Desc = "Delay between auto-buy attempts",
    Step = 0.5,
    Value = { Min = 5, Max = 60, Default = shopRefreshInterval },
    Callback = function(value)
        shopRefreshInterval = tonumber(value) or 5
        if shopRefreshInterval < 5 then
            shopRefreshInterval = 5
            WindUI:Notify({ Title = "Shop", Content = "Minimum auto-buy delay is 5s; set to 5s", Icon = "info", Duration = 2 })
        end
    end,
})

-- Automation tab: move automation-related toggles here
local AutomationTab = Window:Tab({
    Title = "Automation",
    Icon = "play",
    Locked = false,
})

local AutomationSection = AutomationTab:Section({ Title = "Automation", Opened = true })
local FruitDropdown = AutomationSection:Dropdown({
    Title = "Fruit Type",
    Desc = "Select fruit origins to auto-sell",
    Values = {
        "Carrot",
        "Corn",
        "Onion",
        "Strawberry",
        "Mushroom",
        "Beetroot",
        "Tomato",
        "Apple",
        "Rose",
        "Wheat",
        "Banana",
        "Plum",
        "Potato",
        "Cabbage",
        "Cherry",
    },
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitItem = normalizeMultiSelection(option)
    end,
})
AutomationSection:Toggle({
    Title = "Auto Sell Fruit",
    Desc = "Automatically sell selected fruits",
    Icon = "check",
    Value = false,
    Callback = function(state)
        if state then
            if not hasSelection(selectedFruitItem) then
                WindUI:Notify({ Title = "Automation", Content = "Select fruits first!", Icon = "alert-triangle", Duration = 2 })
                autoSellFruit = false
                return
            end
        end
        autoSellFruit = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-sell fruit enabled" or "Auto-sell fruit disabled"), Icon = "info", Duration = 2 })
    end,
})

    -- new seed/plants dropdowns and toggles for snippet logic
    local SeedAutoDropdown = AutomationSection:Dropdown({
        Title = "Seeds to Plant",
        Desc = "Choose which seeds to auto-plant",
        Values = Seeds,
        Value = {},
        Multi = true,
        AllowNone = true,
        SearchBarEnabled = true,
        Callback = function(option)
            selectedSeeds = normalizeMultiSelection(option)
        end,
    })

    local PlantAutoDropdown = AutomationSection:Dropdown({
        Title = "Plants to Harvest",
        Desc = "Choose plant types to auto-harvest",
        -- build plant names list dynamically
        Values = (function()
            local names = {}
            local pf = ReplicatedStorage:FindFirstChild("Plants")
            if pf then
                for _,p in pairs(pf:GetChildren()) do
                    table.insert(names,p.Name)
                end
            end
            return names
        end)(),
        Value = {},
        Multi = true,
        AllowNone = true,
        SearchBarEnabled = true,
        Callback = function(option)
            selectedPlants = normalizeMultiSelection(option)
        end,
    })


    AutomationSection:Toggle({
        Title = "Auto Harvest",
        Desc = "Automatically harvest selected plants",
        Icon = "scythe",
        Value = false,
        Callback = function(state)
            if state and not hasSelection(selectedPlants) then
                WindUI:Notify({ Title = "Automation", Content = "Select plants first!", Icon = "alert-triangle", Duration = 2 })
                autoHarvest = false
                return
            end
            autoHarvest = state
            WindUI:Notify({ Title = "Automation", Content = (state and "Auto-harvest enabled" or "Auto-harvest disabled"), Icon = "info", Duration = 2 })
        end,
    })

    AutomationSection:Toggle({
        Title = "Auto Plant",
        Desc = "Automatically plant selected seeds around you",
        Icon = "seed",
        Value = false,
        Callback = function(state)
            if state and not hasSelection(selectedSeeds) then
                WindUI:Notify({ Title = "Automation", Content = "Select seeds first!", Icon = "alert-triangle", Duration = 2 })
                autoPlant = false
                return
            end
            autoPlant = state
            WindUI:Notify({ Title = "Automation", Content = (state and "Auto-plant enabled" or "Auto-plant disabled"), Icon = "info", Duration = 2 })
        end,
    })

-- fruit auto-sell loop
task.spawn(function()
    while scriptRunning do
        if autoSellFruit and hasSelection(selectedFruitItem) then
            for _, fruit in ipairs(selectedKeys(selectedFruitItem)) do
                local ok, err = pcall(function()
                    if equipFruitTool(fruit) then
                      -- hold fruit then sell

local args = {
    "SellSingle"
}
game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("SellItems"):InvokeServer(unpack(args))
                    end
                end)

                if not ok then
                    warn("Error selling fruit", fruit, err)
                end
                task.wait(0.3)
            end
            task.wait(fruitSellInterval)
        else
            task.wait(1)
        end
    end
end)

-- snippet-style auto plant/harvest loop
local PlantRemote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("PlantSeed")
task.spawn(function()
    while scriptRunning do
        if autoHarvest then
            -- ensure we have a table
            local plantsTable = (type(selectedPlants) == "table") and selectedPlants or {}
            for _,plant in pairs(workspace.ClientPlants:GetChildren()) do
                local base = plant.Name:gsub("%d","")
                if plantsTable[base] then
                    for _,v in pairs(plant:GetDescendants()) do
                        if v:IsA("ProximityPrompt") and v.Name=="HarvestPrompt" then
                            v.HoldDuration=0
                            pcall(function() v:InputHoldBegin() end)
                            task.wait(0.02)
                            pcall(function() v:InputHoldEnd() end)
                        end
                    end
                end
            end
        end
        if autoPlant and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local pos = player.Character.HumanoidRootPart.Position
            local seedsTable = (type(selectedSeeds) == "table") and selectedSeeds or {}
            for seed,on in pairs(seedsTable) do
                if on then
                    for x=-4,4,2 do
                        for z=-4,4,2 do
                            pcall(function()
                                PlantRemote:InvokeServer(seed, pos + Vector3.new(x, -3, z))
                            end)
                        end
                    end
                end
            end
        end
        task.wait(1)
    end
end)




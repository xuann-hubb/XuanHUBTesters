local Players = game:GetService("Players")
local player = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

-- ================= LOAD WINDUI =================
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- ================= SET FONT (IMPORTANT) =================
-- WindUI text font
WindUI:SetFont("rbxasset://fonts/families/GothamSSm.json")

-- ================= CREATE WINDUI WINDOW =================
local Window = WindUI:CreateWindow({
    Folder = "XuanHub",
    Title = "XUAN HUB",
    Author = "by discord.gg/kaydensdens",
    Icon = "rbxassetid://103326199885496",
    Theme = "Dark",
    Size = UDim2.fromOffset(640, 480),
    Draggable = true,
    HasOutline = true,
    HideSearchBar = false,
    OutlineThickness = 3,
    Resizable = true,
    Transparent = true,
    User = {
        Enabled = true,
    },


})

Window:EditOpenButton({
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

-- Add version tag with FPS and Ping counter
local version = game.PlaceVersion -- Server version
local fps = 0
local ping = 0
local Stats = game:GetService("Stats")

local VersionTag = Window:Tag({
    Title = string.format("v%d | Ping: 0 | FPS: 0", version),
    Icon = "solar:server-bold",
    Color = Color3.fromRGB(255, 105, 180), -- Pink color
    Border = true,
})

local frames = 0
local last = os.clock()

RunService.RenderStepped:Connect(function()
    frames = frames + 1
    local now = os.clock()
    if now - last >= 1 then
        fps = frames
        frames = 0
        last = now

        -- Get ping
        pcall(function()
            local item = Stats.Network.ServerStatsItem:FindFirstChild("Data Ping")
            if item then
                ping = math.floor(item:GetValue())
            end
        end)

        -- Update tag
        VersionTag:SetTitle(string.format("v%d | Ping: %d | FPS: %d", version, ping, fps))
    end
end)

local MiscTab = Window:Tab({
    Title = "Settings",
    Icon = "settings",
    Locked = false,
})

-- Anti-AFK (Always Enabled - Prevents 20 min AFK kick)
local vu = game:GetService("VirtualUser")
player.Idled:Connect(function()
    vu:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    vu:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

-- Auto Reconnect (Always Enabled)
pcall(function()
    game.CoreGui.RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(child)
        if child.Name == 'ErrorPrompt' and child:FindFirstChild('MessageArea') and child.MessageArea:FindFirstChild("ErrorFrame") then
            game:GetService("TeleportService"):Teleport(game.PlaceId, player)
        end
    end)
end)

local MiscSettings = MiscTab:Section({
    Title = "Game Settings",
    Opened = true,
})

-- Anti-AFK (Always On)
MiscSettings:Button({
    Title = "Anti-AFK (Always On)",
    Desc = "Prevents AFK kick - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Anti-AFK is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscSettings:Space()

-- Auto Reconnect (Always On)
MiscSettings:Button({
    Title = "Auto Reconnect (Always On)",
    Desc = "Auto rejoin on disconnect - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Auto Reconnect is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscTab:Space()

MiscTab:Section({
    Title = "Server Actions",
    Opened = true,
})

local ServerGroup = MiscTab:Group()

ServerGroup:Button({
    Title = "Server Hop",
    Icon = "solar:refresh-bold",
    Callback = function()
        Window:ServerHop()
    end


})

ServerGroup:Space()

ServerGroup:Button({
    Title = "Rejoin",
    Icon = "solar:restart-bold",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
    end
})

-- ================= MAIN TAB (Shop) =================
local MainTab = Window:Tab({
    Title = "Main Tab",
    Icon = "shopping-cart",
    Locked = false,
})

local ShopSection = MainTab:Section({ Title = "Shop Section", Opened = true })

-- State
local selectedGearItem = {}
local selectedSeedItem = {}
local selectedFruitItem = {}
local autoBuyGear = false
local autoBuySeed = false
local autoSellFruit = false
local shopRefreshInterval = 5 -- seconds between automated purchase attempts (minimum 5s to avoid spam)
local fruitSellInterval = 1 -- seconds between fruit sell attempts
local scriptRunning = true
local autoPlantSeed = false
local plantInterval = 0.8 -- seconds between plant attempts
local autoHarvest = false
local harvestInterval = 0.15

-- Helpers: fetch shop items heuristically
local function fetchShopItems(shopId)
    -- Return exact, hardcoded lists for GearShop and SeedShop to match server item names
    if shopId == "GearShop" then
        return { "Watering Can", "Basic Sprinkler", "Harvest Bell", "Turbo Sprinkler", "Favorite Tool", "Super Sprinkler" }
    elseif shopId == "SeedShop" then
        return {
            "Carrot Seed",
            "Corn Seed",
            "Onion Seed",
            "Strawberry Seed",
            "Mushroom Seed",
            "Beetroot Seed",
            "Tomato Seed",
            "Apple Seed",
            "Rose Seed",
            "Wheat Seed",
            "Banana Seed",
            "Plum Seed",
            "Potato Seed",
            "Cabbage Seed",
            "Cherry Seed",
        }
    end
    return {}
end

-- gather list of fruit harvest origins present in backpack/equipped tools
local function fetchFruitItems()
    local fruits = {}
    local seen = {}
    local bp = player and player:FindFirstChild("Backpack")
    if bp then
        for _, tool in ipairs(bp:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    local char = player and player.Character
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    table.sort(fruits)
    return fruits
end

-- attempt to equip a tool corresponding to given fruit name
local function equipFruitTool(fruitName)
    local bp = player and player:FindFirstChild("Backpack")
    local char = player and player.Character
    if not bp or not char then return false end
    local humanoid = char:FindFirstChild("Humanoid")
    if not humanoid then return false end

    for _, tool in ipairs(bp:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                humanoid:EquipTool(tool)
                return true
            end
        end
    end
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                return true
            end
        end
    end
    return false
end

-- find a seed tool in backpack/character whose BaseName attribute matches seedBase
local function findSeedTool(seedBase)
    if not seedBase then return nil end
    local bp = player and player:FindFirstChild("Backpack")
    local char = player and player.Character
    local function matchTool(tool)
        if not tool or not tool:IsA("Tool") then return false end
        if not tool:IsA("Tool") then return false end
        local bn = tool:GetAttribute("BaseName")
        if bn and tostring(bn):lower() == tostring(seedBase):lower() then
            return true
        end
        -- fallback: name contains the seedBase or full seed name
        if string.find(tostring(tool.Name):lower(), tostring(seedBase):lower()) then
            return true
        end
        return false
    end

    if bp then
        for _, tool in ipairs(bp:GetChildren()) do
            if matchTool(tool) then
                return tool
            end
        end
    end
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            if matchTool(tool) then
                return tool
            end
        end
    end
    return nil
end

-- Attempt to trigger a harvest prompt safely using multiple fallbacks
local function fireHarvestPrompt(prompt)
    if not prompt then return end
    -- try ProximityPrompt-specific calls
    pcall(function()
        if typeof(prompt) == "Instance" and prompt:IsA("ProximityPrompt") then
            -- try InputHoldBegin/End if present
            pcall(function() prompt:InputHoldBegin() end)
            task.wait(0.05)
            pcall(function() prompt:InputHoldEnd() end)
            return
        end
    end)

    -- Generic fallbacks (if the prompt exposes Fire/FireServer/Trigger)
    pcall(function()
        if typeof(prompt.Trigger) == "function" then
            prompt:Trigger()
            return
        end
    end)
    pcall(function()
        if typeof(prompt.Fire) == "function" then
            prompt:Fire()
            return
        end
    end)
    pcall(function()
        if typeof(prompt.FireServer) == "function" then
            prompt:FireServer()
            return
        end
    end)
end

local gearList = {}
local seedList = {}

-- Populate lists (keep them local tables to avoid accidental global usage)
gearList = fetchShopItems("GearShop")
seedList = fetchShopItems("SeedShop")

local GearDropdown = ShopSection:Dropdown({
    Title = "Gear Item",
    Desc = "Select gear to auto-buy",
    Values = gearList,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedGearItem = option or {}
    end,
})

ShopSection:Toggle({
    Title = "Auto Buy Gear",
    Desc = "Automatically purchase selected gear",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuyGear = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy gear enabled" or "Auto-buy gear disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuyGear and scriptRunning do
                    if selectedGearItem and type(selectedGearItem) == "table" and #selectedGearItem > 0 then
                        for _, item in ipairs(selectedGearItem) do
                            pcall(function()
                                local args = { "GearShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})

local SeedDropdown = ShopSection:Dropdown({
    Title = "Seed Item",
    Desc = "Select seed to auto-buy",
    Values = seedList,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedSeedItem = option or {}
    end,
})

ShopSection:Toggle({
    Title = "Auto Buy Seed",
    Desc = "Automatically purchase selected seed",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuySeed = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy seed enabled" or "Auto-buy seed disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuySeed and scriptRunning do
                    if selectedSeedItem and type(selectedSeedItem) == "table" and #selectedSeedItem > 0 then
                        for _, item in ipairs(selectedSeedItem) do
                            pcall(function()
                                local args = { "SeedShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})

-- Fruit dropdown moved to Automation tab (so selection sits with Auto Sell toggle)

-- Refresh buttons removed per user request
-- Slider for auto-buy delay
ShopSection:Slider({
    Title = "Auto Buy Delay (s)",
    Desc = "Delay between auto-buy attempts",
    Step = 0.5,
    Value = { Min = 5, Max = 60, Default = shopRefreshInterval },
    Callback = function(value)
        shopRefreshInterval = tonumber(value) or 5
        if shopRefreshInterval < 5 then
            shopRefreshInterval = 5
            WindUI:Notify({ Title = "Shop", Content = "Minimum auto-buy delay is 5s; set to 5s", Icon = "info", Duration = 2 })
        end
    end,
})

-- Automation tab: move automation-related toggles here
local AutomationTab = Window:Tab({
    Title = "Automation",
    Icon = "play",
    Locked = false,
})

local AutomationSection = AutomationTab:Section({ Title = "Automation", Opened = true })
local FruitDropdown = AutomationSection:Dropdown({
    Title = "Fruit Type",
    Desc = "Select fruit origins to auto-sell",
    Values = {
        "Carrot",
        "Corn",
        "Onion",
        "Strawberry",
        "Mushroom",
        "Beetroot",
        "Tomato",
        "Apple",
        "Rose",
        "Wheat",
        "Banana",
        "Plum",
        "Potato",
        "Cabbage",
        "Cherry",
    },
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitItem = option or {}
    end,
})
AutomationSection:Toggle({
    Title = "Auto Sell Fruit",
    Desc = "Automatically sell selected fruits",
    Icon = "check",
    Value = false,
    Callback = function(state)
        if state then
            if not selectedFruitItem or type(selectedFruitItem) ~= "table" or #selectedFruitItem == 0 then
                WindUI:Notify({ Title = "Automation", Content = "Select fruits first!", Icon = "alert-triangle", Duration = 2 })
                autoSellFruit = false
                return
            end
        end
        autoSellFruit = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-sell fruit enabled" or "Auto-sell fruit disabled"), Icon = "info", Duration = 2 })
    end,
})



-- Auto Plant Seed toggle (uses same Seed dropdown selections)
AutomationSection:Toggle({
    Title = "Auto Plant Seed",
    Desc = "Automatically plant selected seeds on owned plots",
    Icon = "seed",
    Value = false,
    Callback = function(state)
        if state then
            if not selectedSeedItem or type(selectedSeedItem) ~= "table" or #selectedSeedItem == 0 then
                WindUI:Notify({ Title = "Automation", Content = "Select seeds in the Shop tab first!", Icon = "alert-triangle", Duration = 2 })
                autoPlantSeed = false
                return
            end
        end
        autoPlantSeed = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-plant enabled" or "Auto-plant disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoPlantSeed and scriptRunning do
                    local plots = workspace:FindFirstChild("Plots")
                    if plots then
                        for _, plot in ipairs(plots:GetChildren()) do
                            -- verify owner value matches player name
                            local ownerVal = plot:FindFirstChild("Owner")
                            local ownerName = nil
                            if ownerVal and ownerVal.Value then
                                ownerName = tostring(ownerVal.Value)
                            end
                            if ownerName == player.Name then
                                local plantArea = plot:FindFirstChild("PlantableArea")
                                if plantArea then
                                    -- find a basepart inside PlantableArea
                                    local targetPart = nil
                                    for _, c in ipairs(plantArea:GetChildren()) do
                                        if c:IsA("BasePart") then
                                            targetPart = c
                                            break
                                        end
                                    end
                                    if targetPart then
                                        local pos = targetPart.Position
                                        -- try each selected seed
                                        for _, seedFull in ipairs(selectedSeedItem) do
                                            -- derive base name (strip trailing ' Seed')
                                            local seedBase = tostring(seedFull):gsub("%s*[Ss]eed$", "")
                                            local tool = findSeedTool(seedBase)
                                            if tool then
                                                pcall(function()
                                                    -- equip and give small delay
                                                    local char = player.Character
                                                    if char and char:FindFirstChild("Humanoid") then
                                                        char.Humanoid:EquipTool(tool)
                                                    end
                                                    task.wait(0.15)
                                                    local args = { seedBase, Vector3.new(pos.X, pos.Y, pos.Z) }
                                                    local rep = game:GetService("ReplicatedStorage")
                                                    local remote = rep:WaitForChild("RemoteEvents"):WaitForChild("PlantSeed")
                                                    if remote then
                                                        remote:InvokeServer(unpack(args))
                                                    end
                                                end)
                                                task.wait(plantInterval)
                                            end
                                        end
                                    end
                                end
                            end
                            task.wait(0.05)
                        end
                    end
                    task.wait(1)
                end
            end)
        end
    end,
})

    -- Auto Harvest toggle: find HarvestPrompt instances in ClientPlants and fire them
    AutomationSection:Toggle({
        Title = "Auto Harvest",
        Desc = "Automatically fire HarvestPrompts in ClientPlants",
        Icon = "scythe",
        Value = false,
        Callback = function(state)
            autoHarvest = state
            WindUI:Notify({ Title = "Automation", Content = (state and "Auto-harvest enabled" or "Auto-harvest disabled"), Icon = "info", Duration = 2 })
            if state then
                task.spawn(function()
                    while autoHarvest and scriptRunning do
                        local clientPlants = workspace:FindFirstChild("ClientPlants")
                        if clientPlants then
                            for _, obj in ipairs(clientPlants:GetDescendants()) do
                                if obj and (obj.Name == "HarvestPrompt" or (obj.IsA and obj:IsA("ProximityPrompt"))) then
                                    pcall(function()
                                        fireHarvestPrompt(obj)
                                    end)
                                    task.wait(0.02)
                                end
                            end
                        end
                        task.wait(harvestInterval)
                    end
                end)
            end
        end,
    })

-- fruit auto-sell loop
task.spawn(function()
    while scriptRunning do
        if autoSellFruit and selectedFruitItem and type(selectedFruitItem) == "table" and #selectedFruitItem > 0 then
            for _, fruit in ipairs(selectedFruitItem) do
                local ok, err = pcall(function()
                    if equipFruitTool(fruit) then
                      -- hold fruit then sell

local args = {
    "SellSingle"
}
game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("SellItems"):InvokeServer(unpack(args))
                    end
                end)

                if not ok then
                    warn("Error selling fruit", fruit, err)
                end
                task.wait(0.3)
            end
            task.wait(fruitSellInterval)
        else
            task.wait(1)
        end
    end
end)




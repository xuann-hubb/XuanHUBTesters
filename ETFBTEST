local Players = game:GetService("Players")
local player = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local camera = workspace.CurrentCamera

-- ================= LOAD WINDUI =================
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- ================= SET FONT (IMPORTANT) =================
-- WindUI text font
WindUI:SetFont("rbxasset://fonts/families/GothamSSm.json")

-- ================= CREATE WINDUI WINDOW =================
local Window = WindUI:CreateWindow({
    Folder = "XuanHub",
    Title = "XUAN HUB",
    Author = "by discord.gg/kaydensdens",
    Icon = "rbxassetid://103326199885496",
    Theme = "Dark",
    Size = UDim2.fromOffset(640, 480),
    Draggable = true,
    HasOutline = true,
    HideSearchBar = false,
    OutlineThickness = 3,
    Resizable = true,
    Transparent = true,
    User = {
        Enabled = true,
    },


})

Window:EditOpenButton({
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

-- Add version tag with FPS and Ping counter
local version = game.PlaceVersion -- Server version
local fps = 0
local ping = 0
local Stats = game:GetService("Stats")

local VersionTag = Window:Tag({
    Title = string.format("v%d | Ping: 0 | FPS: 0", version),
    Icon = "solar:server-bold",
    Color = Color3.fromRGB(255, 105, 180), -- Pink color
    Border = true,
})

local frames = 0
local last = os.clock()

RunService.RenderStepped:Connect(function()
    frames = frames + 1
    local now = os.clock()
    if now - last >= 1 then
        fps = frames
        frames = 0
        last = now

        -- Get ping
        pcall(function()
            local item = Stats.Network.ServerStatsItem:FindFirstChild("Data Ping")
            if item then
                ping = math.floor(item:GetValue())
            end
        end)

        -- Update tag
        VersionTag:SetTitle(string.format("v%d | Ping: %d | FPS: %d", version, ping, fps))
    end
end)

local MiscTab = Window:Tab({
    Title = "Settings",
    Icon = "settings",
    Locked = false,
})




-- Anti-AFK (Always Enabled - Prevents 20 min AFK kick)
local vu = game:GetService("VirtualUser")
player.Idled:Connect(function()
    vu:Button2Down(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    vu:Button2Up(Vector2.new(0, 0), workspace.CurrentCamera.CFrame)
end)

-- Auto Reconnect (Always Enabled)
pcall(function()
    game.CoreGui.RobloxPromptGui.promptOverlay.ChildAdded:Connect(function(child)
        if child.Name == 'ErrorPrompt' and child:FindFirstChild('MessageArea') and child.MessageArea:FindFirstChild("ErrorFrame") then
            game:GetService("TeleportService"):Teleport(game.PlaceId, player)
        end
    end)
end)

local MiscSettings = MiscTab:Section({
    Title = "Game Settings",
    Opened = true,
})

-- Anti-AFK (Always On)
MiscSettings:Button({
    Title = "Anti-AFK (Always On)",
    Desc = "Prevents AFK kick - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Anti-AFK is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscSettings:Space()

-- Auto Reconnect (Always On)
MiscSettings:Button({
    Title = "Auto Reconnect (Always On)",
    Desc = "Auto rejoin on disconnect - Always enabled",
    Callback = function()
        WindUI:Notify({ Title = "Info", Content = "Auto Reconnect is always enabled", Icon = "info", Duration = 2 })
    end
})

MiscTab:Space()

MiscTab:Section({
    Title = "Server Actions",
    Opened = true,
})

local ServerGroup = MiscTab:Group()

ServerGroup:Button({
    Title = "Server Hop",
    Icon = "solar:refresh-bold",
    Callback = function()
        Window:ServerHop()
    end


})

ServerGroup:Space()

ServerGroup:Button({
    Title = "Rejoin",
    Icon = "solar:restart-bold",
    Callback = function()
        game:GetService("TeleportService"):Teleport(game.PlaceId, player)
    end
})

-- ================= MAIN TAB (Shop) =================
local MainTab = Window:Tab({
    Title = "Main Tab",
    Icon = "shopping-cart",
    Locked = false,
})

local ShopSection = MainTab:Section({ Title = "Shop Section", Opened = true })

-- State
local selectedGearItem = {}
local selectedSeedItem = {}
local selectedFruitItem = {}
local selectedFruitRarities = {}
local selectedSeedPackItem = {}
local autoBuyGear = false
local autoBuySeed = false
local autoSellFruit = false
local autoSellRarity = false
local autoSellAll = false
local autoOpenSeedPack = false
local shopRefreshInterval = 5 -- seconds between automated purchase attempts (minimum 5s to avoid spam)
local fruitSellInterval = 1 -- seconds between fruit sell attempts
local seedPackOpenInterval = 1
local scriptRunning = true
-- auto-plant/auto-harvest state will come from snippet logic
local autoPlant = false
local autoHarvest = false
local plantInterval = 0.8 -- used by snippet if needed
local Seeds = {"Carrot","Tomato","Potato","Wheat","Pumpkin","Corn","Strawberry","Blueberry","Onion","Garlic","Cabbage","Banana","Apple","Plum","Cherry","Mushroom","Rose"}
local selectedSeeds = {}
local selectedPlants = {}
local selectedRipenessStages = {}
local selectedFruitVariants = {}
local selectedFruitMutations = {}
local PlantRemote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("PlantSeed")
local SellRemote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("SellItems")
local SpinRemote = ReplicatedStorage:WaitForChild("RemoteEvents"):WaitForChild("RequestSpin")
local PlantsModels = ReplicatedStorage:FindFirstChild("Plants") and ReplicatedStorage.Plants:FindFirstChild("Models")

local function hasSelection(tbl)
    if type(tbl) ~= "table" then
        return false
    end
    for _, v in pairs(tbl) do
        if v then
            return true
        end
    end
    return false
end

local function withAllOption(values)
    local out = {"All"}
    if type(values) == "table" then
        for _, v in ipairs(values) do
            table.insert(out, v)
        end
    end
    return out
end

local function normalizeMultiSelection(option, allValues)
    local selected = {}
    if type(option) ~= "table" then
        return selected
    end

    local includeAll = false
    for _, value in ipairs(option) do
        local name = type(value) == "table" and value.Title or value
        if type(name) == "string" then
            if name == "All" then
                includeAll = true
            else
                table.insert(selected, name)
            end
        end
    end

    if includeAll then
        selected = {}
        if type(allValues) == "table" then
            for _, v in ipairs(allValues) do
                table.insert(selected, v)
            end
        end
    end

    return selected
end

local function toSelectionSet(option, allValues)
    local selected = {}
    if type(option) ~= "table" then
        return selected
    end

    local includeAll = false
    for key, value in pairs(option) do
        if type(key) == "number" then
            local name = type(value) == "table" and value.Title or value
            if type(name) == "string" then
                if name == "All" then
                    includeAll = true
                else
                    selected[name] = true
                end
            end
        elseif type(key) == "string" and value and key ~= "All" then
            selected[key] = true
        end
    end

    if includeAll and type(allValues) == "table" then
        selected = {}
        for _, v in ipairs(allValues) do
            selected[v] = true
        end
    end

    return selected
end

local function getSeedBaseNameFromTool(tool)
    if not tool or not tool:IsA("Tool") then
        return nil
    end

    local baseName = tool:GetAttribute("BaseName")
    if type(baseName) == "string" then
        return baseName
    end

    return nil
end

local function findAndEquipSeedTool(seedBaseName)
    local char = player.Character
    local backpack = player:FindFirstChild("Backpack")
    if not char or not backpack then
        return false, nil
    end

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        return false, nil
    end

    local wanted = tostring(seedBaseName):lower()

    local function getPlantType(tool)
        local plantType = tool:GetAttribute("PlantType")
        if type(plantType) == "string" and plantType ~= "" then
            return plantType
        end

        local baseName = getSeedBaseNameFromTool(tool)
        if type(baseName) == "string" then
            return baseName:gsub("%s*Seed$", "")
        end
        return nil
    end

    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local baseName = getSeedBaseNameFromTool(tool)
            if type(baseName) == "string" and baseName:lower() == wanted then
                return true, getPlantType(tool)
            end
        end
    end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            local baseName = getSeedBaseNameFromTool(tool)
            if type(baseName) == "string" and baseName:lower() == wanted then
                humanoid:EquipTool(tool)
                task.wait(0.05)
                return true, getPlantType(tool)
            end
        end
    end

    return false, nil
end

local function findAndEquipSeedPackTool(seedPackDisplayName)
    local char = player.Character
    local backpack = player:FindFirstChild("Backpack")
    if not char or not backpack then
        return false
    end

    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        return false
    end

    local wanted = tostring(seedPackDisplayName):lower()

    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local baseName = tool:GetAttribute("BaseName")
            if type(baseName) == "string" and baseName:lower() == wanted then
                return true
            end
        end
    end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            local baseName = tool:GetAttribute("BaseName")
            if type(baseName) == "string" and baseName:lower() == wanted then
                humanoid:EquipTool(tool)
                task.wait(0.05)
                return true
            end
        end
    end

    return false
end

-- previous helper for finding seed tool removed; using direct PlantSeed remote instead
-- Helpers: fetch shop items heuristically
local function fetchShopItems(shopId)
    -- Return exact, hardcoded lists for GearShop and SeedShop to match server item names
    if shopId == "GearShop" then
        return { "Watering Can", "Basic Sprinkler", "Harvest Bell", "Turbo Sprinkler", "Favorite Tool", "Super Sprinkler" }
    elseif shopId == "SeedShop" then
        return {
            "Carrot Seed",
            "Corn Seed",
            "Onion Seed",
            "Strawberry Seed",
            "Mushroom Seed",
            "Beetroot Seed",
            "Tomato Seed",
            "Apple Seed",
            "Rose Seed",
            "Wheat Seed",
            "Banana Seed",
            "Plum Seed",
            "Potato Seed",
            "Cabbage Seed",
            "Cherry Seed",
        }
    end
    return {}
end

-- gather list of fruit harvest origins present in backpack/equipped tools
local function fetchFruitItems()
    local fruits = {}
    local seen = {}
    local bp = player and player:FindFirstChild("Backpack")
    if bp then
        for _, tool in ipairs(bp:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    local char = player and player.Character
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            if tool:IsA("Tool") then
                local hf = tool:GetAttribute("HarvestedFrom")
                if hf and not seen[hf] then
                    seen[hf] = true
                    table.insert(fruits, hf)
                end
            end
        end
    end
    table.sort(fruits)
    return fruits
end

-- attempt to equip a tool corresponding to given fruit name
local function equipFruitTool(fruitName)
    local bp = player and player:FindFirstChild("Backpack")
    local char = player and player.Character
    if not bp or not char then return false end
    local humanoid = char:FindFirstChild("Humanoid")
    if not humanoid then return false end

    for _, tool in ipairs(bp:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                humanoid:EquipTool(tool)
                return true
            end
        end
    end
    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") then
            local hf = tool:GetAttribute("HarvestedFrom")
            if hf and tostring(hf):lower() == tostring(fruitName):lower() then
                return true
            end
        end
    end
    return false
end

-- find a seed tool in backpack/character whose BaseName attribute matches seedBase
-- findSeedTool removed (auto-plant disabled)

-- Attempt to trigger a harvest prompt safely using multiple fallbacks
-- fireHarvestPrompt removed (auto-harvest disabled)

local gearList = {}
local seedList = {}
local fruitList = {"Carrot","Corn","Onion","Strawberry","Mushroom","Beetroot","Tomato","Apple","Rose","Wheat","Banana","Plum","Potato","Cabbage","Cherry"}
local plantSeedList = {"Carrot Seed","Corn Seed","Onion Seed","Strawberry Seed","Mushroom Seed","Beetroot Seed","Tomato Seed","Apple Seed","Rose Seed","Wheat Seed","Banana Seed","Plum Seed","Potato Seed","Cabbage Seed","Cherry Seed"}
local seedsByRarity = {
    Common = {"Carrot", "Corn"},
    Uncommon = {"Onion", "Strawberry", "Mushroom"},
    Rare = {"Beetroot", "Tomato", "Apple", "Rose"},
    Epic = {"Wheat", "Banana", "Plum", "Potato"},
    Legendary = {"Cabbage Seed", "Cherry"},
}
local rarityList = {"Common", "Uncommon", "Rare", "Epic", "Legendary"}
local ripenessStageList = {"Lush", "Repined", "Unripe"}
local fruitVariantList = {"Silver", "Gold", "Normal"}
local fruitMutationList = {"Sandy","Soaked","Shocked","Nova","Starstruck","Snowy","Foggy","Meteoric","Tidal","Flooded","Chilled","Frostbit","Muddy","Mossy"}
local seedPackList = {
    "Gardener Seed Pack",
    "Premium Gardener Seed Pack",
    "Dawn Seed Pack",
    "Premium Dawn Seed Pack",
}

-- Populate lists (keep them local tables to avoid accidental global usage)
gearList = fetchShopItems("GearShop")
seedList = fetchShopItems("SeedShop")
local gearDropdownValues = withAllOption(gearList)
local seedDropdownValues = withAllOption(seedList)
local fruitDropdownValues = withAllOption(fruitList)
local plantSeedDropdownValues = withAllOption(plantSeedList)
local rarityDropdownValues = withAllOption(rarityList)
local ripenessDropdownValues = withAllOption(ripenessStageList)
local fruitVariantDropdownValues = withAllOption(fruitVariantList)
local fruitMutationDropdownValues = withAllOption(fruitMutationList)
local seedPackDropdownValues = withAllOption(seedPackList)

local function normalizeFruitName(name)
    if type(name) ~= "string" then
        return nil
    end
    return (name:gsub("%s*Seed$", ""))
end

local function getRarityFruitList(raritySet)
    local out = {}
    local seen = {}
    if type(raritySet) ~= "table" then
        return out
    end

    for rarity, enabled in pairs(raritySet) do
        if enabled and type(seedsByRarity[rarity]) == "table" then
            for _, name in ipairs(seedsByRarity[rarity]) do
                local fruit = normalizeFruitName(name)
                if fruit and not seen[fruit] then
                    seen[fruit] = true
                    table.insert(out, fruit)
                end
            end
        end
    end
    return out
end



-- Auto Harvest Function (supports optional ripeness + variant + mutation filters)
function autoHarvestPlants(selectedPlants, selectedStages, selectedVariants, selectedMutations)
    local clientPlants = workspace:FindFirstChild("ClientPlants")
    if not clientPlants then
        return
    end

    local plantsTable = (type(selectedPlants) == "table") and selectedPlants or {}
    local stagesTable = (type(selectedStages) == "table") and selectedStages or {}
    local variantsTable = (type(selectedVariants) == "table") and selectedVariants or {}
    local mutationsTable = (type(selectedMutations) == "table") and selectedMutations or {}
    local hasPlantFilter = hasSelection(plantsTable)
    local hasStageFilter = hasSelection(stagesTable)
    local hasVariantFilter = hasSelection(variantsTable)
    local hasMutationFilter = hasSelection(mutationsTable)

    for _, plant in pairs(clientPlants:GetChildren()) do
        local base = plant.Name:gsub("%d","")
        local matchesPlant = (not hasPlantFilter) or plantsTable[base]
        local fruitFilterMatched = (not hasStageFilter and not hasVariantFilter and not hasMutationFilter)

        if not fruitFilterMatched then
            for _, obj in ipairs(plant:GetDescendants()) do
                if obj.Name and obj.Name:match("^Fruit%d+$") then
                    local stage = obj:GetAttribute("RipenessStage")
                    local variant = obj:GetAttribute("Variant")
                    local mutation = obj:GetAttribute("Mutation")

                    local stageOk = (not hasStageFilter) or (type(stage) == "string" and stagesTable[stage])
                    local variantOk = not hasVariantFilter
                    if hasVariantFilter then
                        if type(variant) == "string" and variant ~= "" then
                            variantOk = variantsTable[variant] == true
                        else
                            -- "Normal" means fruit has no Variant attribute set
                            variantOk = variantsTable["Normal"] == true
                        end
                    end

                    local mutationOk = (not hasMutationFilter)
                    if hasMutationFilter and type(mutation) == "string" and mutation ~= "" then
                        mutationOk = mutationsTable[mutation] == true
                    elseif hasMutationFilter then
                        mutationOk = false
                    end

                    if stageOk and variantOk and mutationOk then
                        fruitFilterMatched = true
                        break
                    end
                end
            end
        end

        if matchesPlant and fruitFilterMatched then
            for _, v in ipairs(plant:GetDescendants()) do
                if v:IsA("ProximityPrompt") and v.Name=="HarvestPrompt" then
                    v.HoldDuration = 0
                    if typeof(fireproximityprompt) == "function" then
                        pcall(fireproximityprompt, v)
                    else
                        pcall(function() v:InputHoldBegin() end)
                        task.wait(0.02)
                        pcall(function() v:InputHoldEnd() end)
                    end
                end
            end
        end
    end
end

-- Auto Plant Function
function autoPlantSeeds(selectedSeeds)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local pos = player.Character.HumanoidRootPart.Position
        local seedsTable = (type(selectedSeeds) == "table") and selectedSeeds or {}
        for seedName, enabled in pairs(seedsTable) do
            if enabled then
                local equipped, plantType = findAndEquipSeedTool(seedName)
                if equipped and type(plantType) == "string" and plantType ~= "" then
                    for x=-4,4,2 do
                        for z=-4,4,2 do
                            pcall(function()
                                PlantRemote:InvokeServer(plantType, pos + Vector3.new(x, -3, z))
                            end)
                        end
                    end
                end
            end
        end
    end
end

local GearDropdown = ShopSection:Dropdown({
    Title = "Gear Item",
    Desc = "Select gear to auto-buy",
    Values = gearDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedGearItem = normalizeMultiSelection(option, gearList)
    end,
})
ShopSection:Space()

ShopSection:Toggle({
    Title = "Auto Buy Gear",
    Desc = "Automatically purchase selected gear",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuyGear = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy gear enabled" or "Auto-buy gear disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuyGear and scriptRunning do
                    if selectedGearItem and type(selectedGearItem) == "table" and #selectedGearItem > 0 then
                        for _, item in ipairs(selectedGearItem) do
                            pcall(function()
                                local args = { "GearShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})
ShopSection:Space()

local SeedDropdown = ShopSection:Dropdown({
    Title = "Seed Item",
    Desc = "Select seed to auto-buy",
    Values = seedDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedSeedItem = normalizeMultiSelection(option, seedList)
    end,
})
ShopSection:Space()

ShopSection:Toggle({
    Title = "Auto Buy Seed",
    Desc = "Automatically purchase selected seed",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoBuySeed = state
        WindUI:Notify({ Title = "Shop", Content = (state and "Auto-buy seed enabled" or "Auto-buy seed disabled"), Icon = "info", Duration = 2 })
        if state then
            task.spawn(function()
                while autoBuySeed and scriptRunning do
                    if selectedSeedItem and type(selectedSeedItem) == "table" and #selectedSeedItem > 0 then
                        for _, item in ipairs(selectedSeedItem) do
                            pcall(function()
                                local args = { "SeedShop", item }
                                game:GetService("ReplicatedStorage"):WaitForChild("RemoteEvents"):WaitForChild("PurchaseShopItem"):InvokeServer(unpack(args))
                            end)
                            task.wait(0.25)
                        end
                    end
                    task.wait(shopRefreshInterval)
                end
            end)
        end
    end,
})
ShopSection:Space()

-- Fruit dropdown moved to Automation tab (so selection sits with Auto Sell toggle)

-- Refresh buttons removed per user request
-- Slider for auto-buy delay
ShopSection:Slider({
    Title = "Auto Buy Delay (s)",
    Desc = "Delay between auto-buy attempts",
    Step = 0.5,
    Value = { Min = 5, Max = 60, Default = shopRefreshInterval },
    Callback = function(value)
        shopRefreshInterval = tonumber(value) or 5
        if shopRefreshInterval < 5 then
            shopRefreshInterval = 5
            WindUI:Notify({ Title = "Shop", Content = "Minimum auto-buy delay is 5s; set to 5s", Icon = "info", Duration = 2 })
        end
    end,
})

-- Automation tab: move automation-related toggles here
local AutomationTab = Window:Tab({
    Title = "Automation",
    Icon = "play",
    Locked = false,
})

local SellAutomationSection = AutomationTab:Section({ Title = "Sell Automation", Opened = true })
local FruitDropdown = SellAutomationSection:Dropdown({
    Title = "Fruit Type",
    Desc = "Select fruit origins to auto-sell",
    Values = fruitDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitItem = normalizeMultiSelection(option, fruitList)
    end,
})

SellAutomationSection:Toggle({
    Title = "Auto Sell Fruit",
    Desc = "Automatically sell manually selected fruits",
    Icon = "check",
    Value = false,
    Callback = function(state)
        if state then
            local hasFruitSelection = selectedFruitItem and type(selectedFruitItem) == "table" and #selectedFruitItem > 0
            if not hasFruitSelection then
                WindUI:Notify({ Title = "Automation", Content = "Select fruits first!", Icon = "alert-triangle", Duration = 2 })
                autoSellFruit = false
                return
            end
        end
        autoSellFruit = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-sell fruit enabled" or "Auto-sell fruit disabled"), Icon = "info", Duration = 2 })
    end,
})
SellAutomationSection:Space()

local FruitRarityDropdown = SellAutomationSection:Dropdown({
    Title = "Fruit Rarity",
    Desc = "Select rarities to auto-sell",
    Values = rarityDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitRarities = toSelectionSet(option, rarityList)
    end,
})

SellAutomationSection:Toggle({
    Title = "Auto Sell Rarity",
    Desc = "Automatically sell fruits from selected rarities",
    Icon = "check",
    Value = false,
    Callback = function(state)
        if state and not hasSelection(selectedFruitRarities) then
            WindUI:Notify({ Title = "Automation", Content = "Select rarities first!", Icon = "alert-triangle", Duration = 2 })
            autoSellRarity = false
            return
        end
        autoSellRarity = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-sell rarity enabled" or "Auto-sell rarity disabled"), Icon = "info", Duration = 2 })
    end,
})
SellAutomationSection:Space()

SellAutomationSection:Toggle({
    Title = "Auto Sell All",
    Desc = "Automatically sell everything every 2 seconds",
    Icon = "check",
    Value = false,
    Callback = function(state)
        autoSellAll = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-sell all enabled" or "Auto-sell all disabled"), Icon = "info", Duration = 2 })
    end,
})
SellAutomationSection:Space()

local PlantAutomationSection = AutomationTab:Section({ Title = "Plant Automation", Opened = true })
local SeedAutoDropdown = PlantAutomationSection:Dropdown({
    Title = "Seeds to Plant",
    Desc = "Choose which seeds to auto-plant",
    Values = plantSeedDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedSeeds = toSelectionSet(option, plantSeedList)
    end,
})

PlantAutomationSection:Toggle({
    Title = "Auto Plant",
    Desc = "Automatically plant selected seeds around you",
    Value = false,
    Callback = function(state)
        if state and not hasSelection(selectedSeeds) then
            WindUI:Notify({ Title = "Automation", Content = "Select seeds first!", Icon = "alert-triangle", Duration = 2 })
            autoPlant = false
            return
        end
        autoPlant = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-plant enabled" or "Auto-plant disabled"), Icon = "info", Duration = 2 })
    end,
})
PlantAutomationSection:Space()

local SeedPackAutomationSection = AutomationTab:Section({ Title = "Seed Pack Automation", Opened = true })
local SeedPackDropdown = SeedPackAutomationSection:Dropdown({
    Title = "Seed Pack",
    Desc = "Select seed packs to auto-open",
    Values = seedPackDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedSeedPackItem = normalizeMultiSelection(option, seedPackList)
    end,
})

SeedPackAutomationSection:Toggle({
    Title = "Auto Open Seed Pack",
    Desc = "Equip selected seed pack and open",
    Value = false,
    Callback = function(state)
        if state and (not selectedSeedPackItem or #selectedSeedPackItem == 0) then
            WindUI:Notify({ Title = "Automation", Content = "Select seed pack first!", Icon = "alert-triangle", Duration = 2 })
            autoOpenSeedPack = false
            return
        end
        autoOpenSeedPack = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-open seed pack enabled" or "Auto-open seed pack disabled"), Icon = "info", Duration = 2 })
    end,
})
SeedPackAutomationSection:Space()

local HarvestAutomationSection = AutomationTab:Section({ Title = "Harvest Automation", Opened = true })
local plantValues = {}
if PlantsModels then
    for _, model in ipairs(PlantsModels:GetChildren()) do
        table.insert(plantValues, model.Name)
    end
    table.sort(plantValues)
end
if #plantValues == 0 then
    plantValues = {"Carrot","Tomato","Potato","Wheat","Pumpkin","Corn","Strawberry","Blueberry","Onion","Garlic","Cabbage","Banana","Apple","Plum","Cherry","Mushroom","Rose"}
end
local plantDropdownValues = withAllOption(plantValues)

local PlantAutoDropdown = HarvestAutomationSection:Dropdown({
    Title = "Plants to Harvest",
    Desc = "Choose plant types to auto-harvest",
    Values = plantDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedPlants = toSelectionSet(option, plantValues)
    end,
})

local RipenessDropdown = HarvestAutomationSection:Dropdown({
    Title = "Fruit Ripeness",
    Desc = "Select ripeness stages to auto-harvest fruits",
    Values = ripenessDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedRipenessStages = toSelectionSet(option, ripenessStageList)
    end,
})

local VariantDropdown = HarvestAutomationSection:Dropdown({
    Title = "Fruit Variant",
    Desc = "Select variants to auto-harvest fruits",
    Values = fruitVariantDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitVariants = toSelectionSet(option, fruitVariantList)
    end,
})

local MutationDropdown = HarvestAutomationSection:Dropdown({
    Title = "Fruit Mutation",
    Desc = "Select mutations to auto-harvest fruits",
    Values = fruitMutationDropdownValues,
    Value = {},
    Multi = true,
    AllowNone = true,
    SearchBarEnabled = true,
    Callback = function(option)
        selectedFruitMutations = toSelectionSet(option, fruitMutationList)
    end,
})

HarvestAutomationSection:Toggle({
    Title = "Auto Harvest",
    Desc = "Harvest by selected plants and/or ripeness stages and/or Variant",
    Value = false,
    Callback = function(state)
        local hasPlantSelection = hasSelection(selectedPlants)
        local hasStageSelection = hasSelection(selectedRipenessStages)
        local hasVariantSelection = hasSelection(selectedFruitVariants)
        local hasMutationSelection = hasSelection(selectedFruitMutations)
        if state and (not hasPlantSelection and not hasStageSelection and not hasVariantSelection and not hasMutationSelection) then
            WindUI:Notify({ Title = "Automation", Content = "Select plants, ripeness, variant, or mutation first!", Icon = "alert-triangle", Duration = 2 })
            autoHarvest = false
            return
        end
        autoHarvest = state
        WindUI:Notify({ Title = "Automation", Content = (state and "Auto-harvest enabled" or "Auto-harvest disabled"), Icon = "info", Duration = 2 })
    end,
})
HarvestAutomationSection:Space()

    
    

    
-- fruit auto-sell loop
task.spawn(function()
    while scriptRunning do
        local hasFruitSelection = selectedFruitItem and type(selectedFruitItem) == "table" and #selectedFruitItem > 0
        local hasRaritySelection = hasSelection(selectedFruitRarities)
        if (autoSellFruit and hasFruitSelection) or (autoSellRarity and hasRaritySelection) then
            local fruitsToSell = {}
            local seenFruits = {}
            if autoSellFruit and hasFruitSelection then
                for _, fruit in ipairs(selectedFruitItem) do
                    if type(fruit) == "string" and not seenFruits[fruit] then
                        seenFruits[fruit] = true
                        table.insert(fruitsToSell, fruit)
                    end
                end
            end
            if autoSellRarity and hasRaritySelection then
                for _, fruit in ipairs(getRarityFruitList(selectedFruitRarities)) do
                    if type(fruit) == "string" and not seenFruits[fruit] then
                        seenFruits[fruit] = true
                        table.insert(fruitsToSell, fruit)
                    end
                end
            end

            for _, fruit in ipairs(fruitsToSell) do
                local ok, err = pcall(function()
                    if equipFruitTool(fruit) then
                      -- hold fruit then sell

local args = {
    "SellSingle"
}
SellRemote:InvokeServer(unpack(args))
                    end
                end)

                if not ok then
                    warn("Error selling fruit", fruit, err)
                end
                task.wait(0.3)
            end
            task.wait(fruitSellInterval)
        else
            task.wait(1)
        end
    end
end)

-- auto open seed pack loop
task.spawn(function()
    while scriptRunning do
        if autoOpenSeedPack and selectedSeedPackItem and #selectedSeedPackItem > 0 then
            for _, packName in ipairs(selectedSeedPackItem) do
                local ok, err = pcall(function()
                    if findAndEquipSeedPackTool(packName) then
                        SpinRemote:InvokeServer()
                    end
                end)
                if not ok then
                    warn("Error opening seed pack", packName, err)
                end
                task.wait(0.25)
            end
            task.wait(seedPackOpenInterval)
        else
            task.wait(0.5)
        end
    end
end)

-- auto sell all loop
task.spawn(function()
    while scriptRunning do
        if autoSellAll then
            pcall(function()
                SellRemote:InvokeServer("SellAll")
            end)
            task.wait(2)
        else
            task.wait(0.3)
        end
    end
end)

-- auto plant/harvest loop
task.spawn(function()
    while scriptRunning do
        if autoPlant then
            autoPlantSeeds(selectedSeeds)
        end
        if autoHarvest then
            autoHarvestPlants(selectedPlants, selectedRipenessStages, selectedFruitVariants, selectedFruitMutations)
        end
        task.wait(plantInterval)
    end
end)


local AboutTab = Window:Tab({
    Title = "About",
    Icon = "lucide:notebook-text",
    Locked = false,
})


-- ================= ABOUT TAB =================

AboutTab:Divider()

-- Credits section below image
AboutTab:Paragraph({
    Title = "Credits",
    Desc = "Script Developer: Xuan | UI Library: WindUI | Community: Kayden's Den Discord Server\n\nThank you for using Xuan Hub! Special thanks to all contributors and testers.",
    TextXAlignment = "Center",
    TextSize = 15,
})

AboutTab:Divider()

-- Discord section below credits
AboutTab:Paragraph({
    Title = "Join our discord server!", 
    Desc = "Join our Discord for updates, giveaways, questions, support and more!",
    TextXAlignment = "Center",
    TextSize = 17,
})

local InviteCode = "kaydensdens"

AboutTab:Paragraph({
    Title = "Discord Server",
    Desc = "discord.gg/" .. InviteCode,
})

AboutTab:Button({
    Title = "Copy Discord Invite",
    Callback = function()
        if setclipboard then
            setclipboard("https://discord.gg/" .. InviteCode)
            WindUI:Notify({ Title = "Discord", Content = "Invite link copied!", Icon = "check", Duration = 2 })
        else
            warn("setclipboard() not available in this environment.")
            WindUI:Notify({ Title = "Discord", Content = "Clipboard not supported", Icon = "alert-triangle", Duration = 2 })
        end
    end
})

-- Set Base tab as default
AboutTab:Select()

-- ================= FINALIZE =================
WindUI:Notify({
    Title = "Xuan Hub Loaded",
    Content = "Welcome " .. player.DisplayName .. "!",
    Icon = "check",
    Duration = 5,
})

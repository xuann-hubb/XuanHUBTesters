print("--===== XUAN HUB LOADED (WindUI) =====--")

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")


-- ================= LOAD WINDUI =================
local WindUI = loadstring(game:HttpGet(
    "https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"
))()

-- ================= SET FONT (IMPORTANT) =================
-- WindUI text font
WindUI:SetFont("rbxasset://fonts/families/GothamSSm.json")

-- ================= ADD CUSTOM HOLOGRAPHIC THEME =================
WindUI:AddTheme({
    Name = "Holographic", -- theme name

    Accent = WindUI:Gradient({
        ["0"] = { Color = Color3.fromHex("#1ABC9C"), Transparency = 0 },   -- Teal start
        ["50"] = { Color = Color3.fromHex("#3498DB"), Transparency = 0 },  -- Blue middle
        ["100"] = { Color = Color3.fromHex("#9B59B6"), Transparency = 0 }, -- Purple end
    }, {
        Rotation = 45,
    }),
    Outline = Color3.fromHex("#1ABC9C"),     -- Holographic teal outline
    Text = Color3.fromHex("#FFFFFF"),        -- Pure white text
    Placeholder = Color3.fromHex("#7F8C8D"), -- Gray placeholder
    Button = Color3.fromHex("#E70AD5"),      -- Darker holographic teal
    Icon = Color3.fromHex("#3DFFDC"),        -- Light holographic cyan
})

-- ================= SETTINGS PERSISTENCE =================
local settingsFileName = "XuanHubConfig_SLFB.json"
local defaultSettings = {
    -- autoSellAll removed per user request
    speedUpgradeAmount = 1,
    autoUpgradeSpeed = false,
    autoUpgradeBase = false,
    autoUpgradeCarry = false,
    infJump = false,
    immuneToLava = false,
    autoFarmCelestials = false,
    removeVIPWalls = false,
}

local function loadSettings()
    if not isfolder("XuanHub") then
        makefolder("XuanHub")
    end

    if isfile("XuanHub/" .. settingsFileName) then
        local success, data = pcall(function()
            return HttpService:JSONDecode(readfile("XuanHub/" .. settingsFileName))
        end)
        if success and data then
            return data
        end
    end

    -- no settings file or parse failed: return a safe copy of defaults
    local ok, copy = pcall(function()
        return HttpService:JSONDecode(HttpService:JSONEncode(defaultSettings))
    end)
    if ok and type(copy) == "table" then
        return copy
    end

    return defaultSettings
end

local function saveSettings(settings)
    pcall(function()
        if not isfolder("XuanHub") then
            makefolder("XuanHub")
        end
        writefile("XuanHub/" .. settingsFileName, HttpService:JSONEncode(settings))
    end)
end

local savedSettings = loadSettings()

-- Helper: get the player's plot instance (returns Instance or nil)
local function GetMyPlot()
    local plotName = player and player:GetAttribute("Plot")
    if not plotName or plotName == "" then return nil end
    local gf = workspace:FindFirstChild("GameFolder")
    local plots = gf and gf:FindFirstChild("Plots")
    return plots and plots:FindFirstChild(plotName) or nil
end

-- ================= CREATE WINDUI WINDOW =================
local Window = WindUI:CreateWindow({
    Folder = "XuanHub",
    Title = "XUAN HUB",
    Author = "by discord.gg/kaydensdens",
    Icon = "rbxassetid://103326199885496",
    Theme = "Holographic", -- Use custom holographic theme
    Size = UDim2.fromOffset(640, 480),
    Draggable = true,
    HasOutline = true,
    OutlineThickness = 3,
    Resizable = true,
    Transparent = true,
    User = {
        Enabled = true,
    },
})

-- ================= LOADING NOTIFICATIONS =================
task.spawn(function()
    WindUI:Notify({
        Title = "Verifying",
        Content = "Verifying string data...",
        Duration = 2
    })
    
    task.wait(2)
    
    WindUI:Notify({
        Title = "Verifying",
        Content = "Verifying environment...",
        Duration = 2
    })
    
    task.wait(2)
    
    WindUI:Notify({
        Title = "Verifying",
        Content = "Verifying anti-cheat data...",
        Duration = 2
    })
    
    task.wait(2)
    
    WindUI:Notify({
        Title = "Success",
        Content = "Operation completed successfully",
        Duration = 3
    })
end)

Window:EditOpenButton({
    OnlyMobile = false,
    Enabled = true,
    Draggable = true,
})

-- Add version tag with FPS and Ping counter
local version = game.PlaceVersion -- Server version
local fps = 0
local ping = 0
local Stats = game:GetService("Stats")

local VersionTag = Window:Tag({
    Title = string.format("v%d | Ping: 0 | FPS: 0", version),
    Icon = "solar:server-bold",
    Color = Color3.fromRGB(255, 105, 180), -- Pink color
    Border = true,
})

local frames = 0
local last = os.clock()

RunService.RenderStepped:Connect(function()
    frames = frames + 1
    local now = os.clock()
    if now - last >= 1 then
        fps = frames
        frames = 0
        last = now

        -- Get ping
        pcall(function()
            local item = Stats.Network.ServerStatsItem:FindFirstChild("Data Ping")
            if item then
                ping = math.floor(item:GetValue())
            end
        end)

        -- Update tag
        VersionTag:SetTitle(string.format("v%d | Ping: %d | FPS: %d", version, ping, fps))
    end
end)



-- ================= MAIN TAB =================
local MainTab = Window:Tab({
    Title = "Main",
    Icon = "lucide:house",
})

local MainSection = MainTab:Section({
    Title = "Main Features",
    Opened = true,
})

MainTab:Select()
-- Auto states
local speedUpgradeAmount = savedSettings.speedUpgradeAmount or 1
local autoUpgradeSpeed = savedSettings.autoUpgradeSpeed or false
local autoUpgradeBase = savedSettings.autoUpgradeBase or false
local autoUpgradeCarry = savedSettings.autoUpgradeCarry or false
local infJump = savedSettings.infJump or false
local immuneToLava = savedSettings.immuneToLava or false
local autoFarmCelestials = savedSettings.autoFarmCelestials or false
local removeVIPWalls = savedSettings.removeVIPWalls or false
local vipConn  -- Connection for VIP wall removal
local grabConn -- Connection for auto-grab prompt HoldDuration management

-- Upgrade Base Button
MainSection:Button({
    Title = "Upgrade Base",
    Desc = "Upgrade your base once",
    Callback = function()
        pcall(function()
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Upgrade"):InvokeServer()
            WindUI:Notify({
                Title = "Upgrade",
                Content = "Base upgraded!",
                Icon = "check",
                Duration = 2,
            })
        end)
    end,
})



-- Upgrade Speed Button (one-time)
MainSection:Button({
    Title = "Upgrade Speed",
    Desc = "Upgrade speed once with selected amount",
    Callback = function()
        pcall(function()
            local args = { "Speed", speedUpgradeAmount }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Speed"):InvokeServer(unpack(args))
            WindUI:Notify({
                Title = "Speed",
                Content = "Speed upgraded x" .. speedUpgradeAmount .. "!",
                Icon = "zap",
                Duration = 2,
            })
        end)
    end,
})

-- Upgrade Carry Button
MainSection:Button({
    Title = "Upgrade Carry",
    Desc = "Upgrade carry capacity",
    Callback = function()
        pcall(function()
            local args = { "Carry" }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Carry"):InvokeServer(unpack(args))
            WindUI:Notify({
                Title = "Carry",
                Content = "Carry upgraded!",
                Icon = "package",
                Duration = 2,
            })
        end)
    end,
})

-- Sell Held Tool Button
MainSection:Button({
    Title = "Sell Held Tool",
    Desc = "Sell one held item",
    Callback = function()
        pcall(function()
            local args = { "SellOne" }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("SellDialogue"):InvokeServer(unpack(
            args))
            WindUI:Notify({
                Title = "Sell",
                Content = "Sold held tool!",
                Icon = "dollar-sign",
                Duration = 2,
            })
        end)
    end,
})

-- Sell Entire Inventory Button
MainSection:Button({
    Title = "Sell Entire Inventory",
    Desc = "Sell all items at once",
    Callback = function()
        pcall(function()
            local args = { "SellAll" }
            game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("SellDialogue"):InvokeServer(unpack(
            args))
            WindUI:Notify({
                Title = "Sell",
                Content = "Sold entire inventory!",
                Icon = "dollar-sign",
                Duration = 2,
            })
        end)
    end,
})

-- Remove VIP Walls Toggle
-- Unlock VIP Walls (one-shot)
MainSection:Button({
    Title = "Unlock VIP Walls",
    Desc = "Destroy VIP doors/walls (one-time)",
    Callback = function()
        for _, v in pairs(workspace:GetDescendants()) do
            if v.Name == "VIPDoors" or v.Name == "VIPDoor" then
                pcall(function() v:Destroy() end)
            end
        end
        WindUI:Notify({ Title = "VIP Walls", Content = "Removed existing VIP walls.", Icon = "check", Duration = 2 })
    end,
})

-- Teleport to My Plot Button
MainSection:Button({
    Title = "TP To My Plot",
    Desc = "Teleport your character to your plot pivot",
    Callback = function()
        local plot = GetMyPlot()
        if not plot then
            pcall(function()
                WindUI:Notify({ Title = "TP", Content = "No plot found (check your Plot attribute)", Icon =
                "alert-triangle", Duration = 2 })
            end)
            return
        end

        pcall(function()
            if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local pivot = plot:GetPivot()
                -- match the original script's offset and orientation
                player.Character:PivotTo(pivot * CFrame.new(0, 4, -10) * CFrame.Angles(0, math.pi, 0))
                WindUI:Notify({ Title = "TP", Content = "Teleported to your plot", Icon = "check", Duration = 2 })
            end
        end)
    end,
})

-- ================= UTILITIES SECTION =================
local UtilitiesSection = MainTab:Section({
    Title = "Utilities",
    Opened = true,
})

-- Infinite Jump Toggle
UtilitiesSection:Toggle({
    Title = "Infinite Jump",
    Desc = "Jump infinitely without cooldown",
    Value = savedSettings.infJump,
    Callback = function(state)
        infJump = state
        savedSettings.infJump = state
        saveSettings(savedSettings)

        WindUI:Notify({
            Title = "Infinite Jump",
            Content = state and "Infinite Jump enabled!" or "Infinite Jump disabled",
            Icon = state and "check" or "x",
            Duration = 2,
        })
    end,
})

-- Immune to Lava Toggle
UtilitiesSection:Toggle({
    Title = "Immune to Lava",
    Desc = "Domain expansion lava immunity",
    Value = savedSettings.immuneToLava,
    Callback = function(state)
        immuneToLava = state
        savedSettings.immuneToLava = state
        saveSettings(savedSettings)

        if state then
            pcall(function()
                local lavas = workspace:FindFirstChild("GameFolder") and workspace.GameFolder:FindFirstChild("Lavas") and workspace.GameFolder.Lavas:FindFirstChild("Lava")
                if lavas then
                    -- Destroy specific TouchInterest
                    local lavasParent = workspace.GameFolder.Lavas
                    if lavasParent:GetChildren()[8] then
                        local ti = lavasParent:GetChildren()[8]:FindFirstChild("TouchInterest")
                        if ti then ti:Destroy() end
                    end

                    -- For children 2-10 of Lavas.Lava
                    local children = lavas:GetChildren()
                    for i = 2, math.min(10, #children) do
                        local child = children[i]
                        if child and child:IsA("BasePart") then
                            child.CanCollide = false
                            child.CanQuery = false
                            child.CanTouch = false
                            local touchInterest = child:FindFirstChild("TouchInterest")
                            if touchInterest then
                                touchInterest:Destroy()
                            end
                        end
                    end
                end
            end)
        end

        WindUI:Notify({
            Title = "Immune to Lava",
            Content = state and "Lava immunity enabled!" or "Lava immunity disabled",
            Icon = state and "check" or "x",
            Duration = 2,
        })
    end,
})

-- Infinite Jump Logic
local UserInputService = game:GetService("UserInputService")
UserInputService.JumpRequest:Connect(function()
    if infJump then
        local char = player.Character
        if char and char:FindFirstChild("Humanoid") then
            char.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end
end)

-- ================= LOOP TAB =================
local AutoTab = Window:Tab({
    Title = "Loop",
    Icon = "lucide:bot",
})

local AutoSection = AutoTab:Section({
    Title = "Continuous Features",
    Opened = true,
})

-- Speed Upgrade Amount Dropdown
AutoSection:Dropdown({
    Title = "Speed Upgrade Amount",
    Desc = "Select upgrade amount for loop speed",
    Values = { "1", "5", "10" },
    Value = tostring(savedSettings.speedUpgradeAmount or 1),
    Callback = function(value)
        speedUpgradeAmount = tonumber(value)
        savedSettings.speedUpgradeAmount = speedUpgradeAmount
        saveSettings(savedSettings)
    end,
})

AutoSection:Toggle({
    Title = "Loop Upgrade Speed",
    Desc = "Continuously upgrade speed",
    Value = savedSettings.autoUpgradeSpeed,
    Callback = function(state)
        autoUpgradeSpeed = state
        savedSettings.autoUpgradeSpeed = state
        saveSettings(savedSettings)

        WindUI:Notify({
            Title = "Loop Upgrade Speed",
            Content = state and "Loop Upgrade enabled!" or "Loop Upgrade disabled",
            Icon = state and "check" or "x",
            Duration = 2,
        })
    end,
})

-- Loop Upgrade Base Toggle
AutoSection:Toggle({
    Title = "Loop Upgrade Base",
    Desc = "Continuously upgrade base when possible",
    Value = savedSettings.autoUpgradeBase,
    Callback = function(state)
        autoUpgradeBase = state
        savedSettings.autoUpgradeBase = state
        saveSettings(savedSettings)
        WindUI:Notify({ Title = "Loop Upgrade Base", Content = state and "Enabled" or "Disabled", Icon = state and
        "check" or "x", Duration = 2 })
    end,
})

-- Loop Upgrade Carry Toggle
AutoSection:Toggle({
    Title = "Loop Upgrade Carry",
    Desc = "Continuously upgrade carry when possible",
    Value = savedSettings.autoUpgradeCarry,
    Callback = function(state)
        autoUpgradeCarry = state
        savedSettings.autoUpgradeCarry = state
        saveSettings(savedSettings)
        WindUI:Notify({ Title = "Loop Upgrade Carry", Content = state and "Enabled" or "Disabled", Icon = state and
        "check" or "x", Duration = 2 })
    end,
})

-- Farm Rare Items Toggle
AutoSection:Toggle({
    Title = "Farm Rare Items",
    Desc = "Gather rare brainrots (TP → Grab → Safezone)",
    Value = savedSettings.autoFarmCelestials,
    Callback = function(state)
        autoFarmCelestials = state
        savedSettings.autoFarmCelestials = state
        saveSettings(savedSettings)

        WindUI:Notify({
            Title = "Farm Rare Items",
            Content = state and "Farming enabled!" or "Farming disabled",
            Icon = state and "check" or "x",
            Duration = 2,
        })
    end,
})

-- Auto Sell loop removed (user requested)

-- Auto Upgrade Speed Loop
task.spawn(function()
    while task.wait(1) do
        if autoUpgradeSpeed then
            pcall(function()
                local args = { "Speed", speedUpgradeAmount }
                game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Speed"):InvokeServer(unpack(
                args))
            end)
        end
    end
end)

-- Auto Upgrade Base Loop
task.spawn(function()
    while task.wait(1) do
        if autoUpgradeBase then
            pcall(function()
                game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Upgrade"):InvokeServer()
            end)
        end
    end
end)

-- Auto Upgrade Carry Loop
task.spawn(function()
    while task.wait(1) do
        if autoUpgradeCarry then
            pcall(function()
                local args = { "Carry" }
                game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("Carry"):InvokeServer(unpack(
                args))
            end)
        end
    end
end)

-- Auto Farm Celestials Loop
task.spawn(function()
    while task.wait(3) do -- Check every 3 seconds
        if autoFarmCelestials then
            pcall(function()
                -- 1. TP to Celestial brainrots
                local path = workspace:FindFirstChild("GameFolder")
                if path then
                    local celestial = path:FindFirstChild("Brainrots") and path.Brainrots:FindFirstChild("Celestial")
                    if celestial then
                        for _, obj in pairs(celestial:GetChildren()) do
                            local root = obj:FindFirstChildWhichIsA("BasePart") or obj:FindFirstChild("HumanoidRootPart")
                            if root and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                                -- 1. Teleport to celestial
                                player.Character.HumanoidRootPart.CFrame = root.CFrame

                                -- 2. Wait 5 seconds
                                task.wait(5)

                                -- 3. TP to safezone/Baseplate
                                local baseplate = workspace:FindFirstChild("GameFolder") and
                                workspace.GameFolder:FindFirstChild("Baseplate")
                                if baseplate and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                                    player.Character.HumanoidRootPart.CFrame = baseplate.CFrame + Vector3.new(0, 5, 0)
                                end

                                break -- Only process first celestial found
                            end
                        end
                    end
                end
            end)
        end
    end
end)
